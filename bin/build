#!/bin/bash
set -euo pipefail

REPO_PATH="$( dirname "$( cd "$(dirname "$0")" ; pwd -P )" )"

# Change into the repo's dir so that docker-compose .env works correctly:
pushd "$REPO_PATH"

# Clean our HASS refresh tokens:
"$REPO_PATH/bin/clean-hass-refresh-tokens"

# Re-build the containers if necessary:
docker-compose build --pull

# Tear the stack down and clean up loose containers and images:
docker-compose down --remove-orphans
docker container prune -f
docker image prune -f

# Bring up the stack, focusing on giving critical services time to start up first:
docker-compose up -d vernemq
sleep 5
docker-compose up -d openzwave
sleep 5
docker-compose up -d

# Do a final cleanup of unused networks and volumes:
docker network prune -f
docker volume prune -f

# Go back to where we started:
popd

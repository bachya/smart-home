#!/bin/bash
set -euxo pipefail

REPO_PATH="$( dirname $( cd "$(dirname "$0")" ; pwd -P ) )"

function copy_config_data() {
  volume_name=$1
  settings_path=$2

  docker volume create $volume_name

  docker run --rm \
    -v $settings_path:/src \
    -v $volume_name:/data \
    -w /src \
    busybox \
    cp -a . /data
}

# Update AppDaemon configs:
copy_config_data "hub_appdaemon-config" "$REPO_PATH/appdaemon/settings"

# Update Glances configs:
copy_config_data "hub_glances-config" "$REPO_PATH/glances/settings"

# Update Home Assistant configs:
copy_config_data "hub_hass-config" "$REPO_PATH/home-assistant/settings"

# Re-build the containers if necessary:
docker-compose build

# Tear the stack down and clean up loose containers and images:
docker-compose down --remove-orphans
docker container prune -f
docker image prune -f

# Bring up all "background" services:
docker-compose up -d --scale appdaemon=0 --scale hass=0

# Bring up HASS and AppDaemon with delays in-between:
sleep 5
docker-compose up -d hass
sleep 5
docker-compose up -d appdaemon

# Do a final cleanup of unused networks and volumes:
docker network prune -f
docker volume prune -f

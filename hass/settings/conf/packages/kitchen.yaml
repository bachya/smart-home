---
automation:
  - alias: "Manage dishwasher state"
    id: "manage_dishwasher_state"
    mode: restart
    trigger:
      - platform: numeric_state
        entity_id: sensor.dishwasher_electric_consumed_w
        id: high_power
        above: 9
      - platform: numeric_state
        below: 4
        entity_id: sensor.dishwasher_electric_consumed_w
        id: low_power
        for:
          minutes: 5
      - platform: state
        entity_id: input_select.dishwasher_status
        for:
          minutes: 20
        id: clean
        to: Drying
    action:
      choose:
        - conditions:
            condition: trigger
            id: high_power
          sequence:
            service: input_select.select_option
            data:
              entity_id: input_select.dishwasher_status
              option: Running
        - conditions:
            - condition: trigger
              id: low_power
            - condition: state
              entity_id: input_select.dishwasher_status
              state: Running
          sequence:
            service: input_select.select_option
            data:
              entity_id: input_select.dishwasher_status
              option: Drying
        - conditions:
            - condition: trigger
              id: clean
          sequence:
            service: input_select.select_option
            data:
              entity_id: input_select.dishwasher_status
              option: Clean

  - alias: "Notify when the dishwasher is clean"
    id: "dishwasher_clean"
    trigger:
      platform: state
      entity_id: input_select.dishwasher_status
      to: Clean
    action:
      repeat:
        sequence:
          - service: script.notify_everyone_at_home
            data:
              message: "ðŸ½  The dishwasher is clean and can be emptied."
              title: Dishwasher Done
          - delay: "02:00:00"
        until:
          - condition: state
            entity_id: input_select.dishwasher_status
            state: Dirty

  - alias: "Notify when there is a leak under the kitchen sink"
    id: "kitchen_sink_leak"
    trigger:
      platform: state
      entity_id: binary_sensor.kitchen_sink_sensor_leak_detector
      to: "on"
    action:
      repeat:
        sequence:
          - service: notify.everyone
            data:
              message: "ðŸ’¦ Leak detected under the kitchen sink!"
              title: Kitchen Sink Leak
          - delay: "00:01:00"
        until:
          - condition: state
            entity_id: binary_sensor.kitchen_sink_sensor_leak_detector
            state: "off"

  - alias: "Turn kitchen lights on when we arrive at night"
    id: "turn_kitchen_lights_on_when_we_arrive_at_night"
    trigger:
      platform: state
      entity_id: sensor.proximity_zone
      to: Home
    condition:
      condition: and
      conditions:
        - condition: sun
          after: sunset
          # This condition ensures that when  sensor.proximity_zone goes from
          # unavailable to Home (e.g., after a deployment), the lights don't
          # turn on:
        - condition: template
          value_template: >
            {{ trigger.from_state.state != "unavailable"}}
    action:
      service: switch.turn_on
      data:
        entity_id:
          - switch.kitchen_pendant_lights
          - switch.mud_counter_lights

  - alias: "Turn kitchen pendant light on at sunset"
    id: "turn_kitchen_pendant_light_on_at_sunset"
    trigger:
      platform: event
      event_type: LOCAL_SUNSET
    action:
      service: switch.turn_on
      data:
        entity_id: switch.kitchen_pendant_lights

group:
  kitchen_lights:
    entities:
      - light.kitchen_can_lights
      - switch.bar_cart_leds
      - switch.kitchen_pendant_lights
      - switch.mud_counter_lights

input_select:
  dishwasher_status:
    name: Status
    options:
      - Dirty
      - Running
      - Drying
      - Clean

script:
  empty_dishwasher:
    sequence:
      - service: input_select.select_option
        data:
          entity_id: input_select.dishwasher_status
          option: Dirty

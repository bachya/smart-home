---
alert:
  fiddle_leaf_fig_moisture:
    name: "ðŸŒ´ Fred is low on moisture and needs a drink."
    title: Fred's Moisture
    entity_id: binary_sensor.should_notify_about_fred_dry
    state: "on"
    repeat:
      - 60
    skip_first: true
    notifiers:
      - everyone

automation:
  - alias: "Turn living room lights on when we arrive at night"
    id: "turn_living_room_lights_on_when_we_arrive_at_night"
    trigger:
      platform: state
      entity_id: sensor.proximity_zone
      to: Home
    condition:
      condition: and
      conditions:
        - condition: sun
          after: sunset
          # This condition ensures that when  sensor.proximity_zone goes from
          # unavailable to Home (e.g., after a deployment), the lights don't
          # turn on:
        - condition: template
          value_template: >
            {{ trigger.from_state.state != "unavailable"}}
    action:
      service: switch.turn_on
      data:
        entity_id: group.living_room_lights

  - alias: "Turn living room lights on at sunset"
    id: "turn_living_room_lights_on_at_sunset"
    trigger:
      platform: event
      event_type: LOCAL_SUNSET
    action:
      service: homeassistant.turn_on
      data:
        entity_id:
          - switch.christmas_tree
          - switch.reading_lamp

  - alias: "Turn powder room fan back on if someone turns it off"
    id: "turn_powder_room_fan_back_on_if_someone_turns_it_off"
    trigger:
      platform: state
      entity_id: switch.powder_room_fan
      to: "off"
      for:
        minutes: 1
    action:
      service: switch.turn_on
      data:
        entity_id: switch.powder_room_fan

binary_sensor:
  - platform: template
    sensors:
      should_notify_about_fred_dry:
        value_template: >-
          {{
            not is_state("sensor.fiddle_leaf_fig_moisture", "unknown") and
            states("sensor.fiddle_leaf_fig_moisture") | int < 10
          }}

group:
  living_room_lights:
    entities:
      - switch.christmas_tree
      - switch.reading_lamp
      - switch.sofa_lamp

script:
  simulate_watching_roku:
    alias: Simulate watching a Roku
    fields:
      app:
        description: The Roku app to select
        example: Netflix
      harmony_remote:
        description: The Harmony Hub remote entity
        example: remote.living_room_tv
      roku_media_player:
        description: The Roku media player entity
        example: media_player.living_room_roku
      roku_remote:
        description: The Roku remote entity
        example: remote.living_room_roku
    sequence:
      - service: remote.turn_on
        target:
          entity_id: "{{ harmony_remote }}"
      - service: media_player.select_source
        target:
          entity_id: "{{ roku_media_player }}"
        data:
          source: "{{ app }}"
      - delay: "00:00:15"
      - service: remote.send_command
        target:
          entity_id: "{{ roku_remote }}"
        data:
          command: Select

  turn_roku_off:
    alias: Turn a Roku off
    fields:
      harmony_remote:
        description: The Harmony Hub remote entity
        example: remote.living_room_tv
      roku_remote:
        description: The Roku remote entity
        example: remote.living_room_roku
    sequence:
      - service: remote.send_command
        target:
          entity_id: "{{ roku_remote }}"
        data:
          command: Home
      - delay: "00:00:03"
      - service: remote.turn_off
        target:
          entity_id: "{{ harmony_remote }}"

sensor:
  - platform: filter
    name: "Filtered Fiddle Leaf Fig Brightness (%)"
    entity_id: sensor.fiddle_leaf_fig_brightness
    filters:
      - filter: range
        upper_bound: 100

  - platform: mqtt
    name: Fiddle Leaf Fig Moisture
    state_topic: "miflora/FiddleLeafFig"
    value_template: "{{ value_json.moisture }}"
    unit_of_measurement: "%"
    icon: "mdi:water-percent"
    force_update: true

  - platform: template
    sensors:
      fiddle_leaf_fig_brightness:
        friendly_name: "Living Room: Brightness (Perception)"
        value_template: >
          {{ (
            states("sensor.fiddle_leaf_fig_brightness") | int | log(10)/5
          ) | round(2) * 100 }}
        unit_of_measurement: "%"
        device_class: illuminance

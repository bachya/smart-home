---
automation:
  - alias: "Notify when there is a leak near the sump pump"
    id: "basement_leak"
    trigger:
      - platform: state
        entity_id: binary_sensor.basement_sensor_leak_detector
        to: "on"
      - platform: state
        entity_id: binary_sensor.guardian_b4e62d98118d_leak_detected
        to: "on"
    action:
      repeat:
        sequence:
          - service: script.turn_on
            target:
              entity_id: script.notify_everyone_at_home
            data:
              variables:
                interruption_level: critical
                message: "ðŸ’¦ Leak detected in the basement!"
                title: Basement Leak
          - delay: "00:01:00"
        until:
          - condition: state
            entity_id: binary_sensor.basement_sensor_leak_detector
            state: "off"
          - condition: state
            entity_id: binary_sensor.guardian_b4e62d98118d_leak_detected
            state: "off"

  - alias: "Reboot Guardian every night at 2am"
    id: "reboot_guardian_every_night_at_2am"
    trigger:
      platform: time
      at: "02:00:00"
    action:
      service: guardian.reboot
      target:
        entity_id: switch.guardian_b4e62d98118d_valve

binary_sensor:
  - platform: template
    sensors:
      sump_pump_on:
        friendly_name: Sump Pump On
        value_template: >
          {{ states("sensor.sump_pump_electric_consumed_w") | int > 0 }}

sensor:
  - platform: history_stats
    name: Sump Pump Runs (Today)
    entity_id: binary_sensor.sump_pump_on
    state: "on"
    type: count
    start: >
      {{ now().replace(hour=0, minute=0, second=0) }}
    end: "{{ now() }}"

  - platform: history_stats
    name: Sump Pump Runs (This Week)
    entity_id: binary_sensor.sump_pump_on
    state: "on"
    type: count
    start: >
      {{
        as_timestamp(now().replace(hour=0, minute=0, second=0))
        - now().weekday() * 86400
      }}
    end: "{{ now() }}"

  - platform: min_max
    name: Average Basement Temperature
    type: mean
    round_digits: 1
    entity_ids:
      - sensor.basement_sensor_temperature
      - sensor.basement_firefighter_air_temperature

sonos:
  media_player:
    hosts:
      - 172.16.20.113
      - 172.16.20.155
      - 172.16.20.18
      - 172.16.20.253

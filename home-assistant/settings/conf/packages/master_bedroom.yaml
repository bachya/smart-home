---
automation:
  - alias: Cancel master bathroom fan timer
    trigger:
      - platform: numeric_state
        entity_id: input_number.master_bathroom_fan_timer
        below: 1
      - platform: state
        entity_id: switch.master_bathroom_fan
        to: "off"
    action:
      - service: input_number.set_value
        data:
          entity_id: input_number.master_bathroom_fan_timer
          value: 0
      - service: switch.turn_off
        data:
          entity_id: switch.master_bathroom_fan
      - service: timer.cancel
        data:
          entity_id: timer.master_bathroom_fan

  - alias: Set master bathroom fan timer
    trigger:
      platform: state
      entity_id: input_number.master_bathroom_fan_timer
    action:
      - service: switch.turn_on
        data:
          entity_id: switch.master_bathroom_fan
      - service: timer.start
        data_template:
          entity_id: timer.master_bathroom_fan_timer
          duration: >
            {{ states("input_number.master_bathroom_fan_timer") | int * 60 }}

  - alias: "Set sleep timer on master bathroom fan when switch double tapped"
    trigger:
      platform: event
      event_type: zwave.node_event
      event_data:
        entity_id: zwave.master_bathroom_fan
        basic_level: 255
    action:
      service: input_number.set_value
      data:
        entity_id: input_number.master_bathroom_fan_timer
        value: 30

  - alias: Cancel master toilet fan timer
    trigger:
      - platform: numeric_state
        entity_id: input_number.master_toilet_fan_timer
        below: 1
      - platform: state
        entity_id: switch.master_toilet_fan
        to: "off"
    action:
      - service: input_number.set_value
        data:
          entity_id: input_number.master_toilet_fan_timer
          value: 0
      - service: switch.turn_off
        data:
          entity_id: switch.master_toilet_fan
      - service: timer.cancel
        data:
          entity_id: timer.master_toilet_fan

  - alias: Set master toilet fan timer
    trigger:
      platform: state
      entity_id: input_number.master_toilet_fan_timer
    action:
      - service: switch.turn_on
        data:
          entity_id: switch.master_toilet_fan
      - service: timer.start
        data_template:
          entity_id: timer.master_toilet_fan_timer
          duration: >
            {{ states("input_number.master_toilet_fan_timer") | int * 60 }}

  - alias: "Set sleep timer on master toilet fan when switch double tapped"
    trigger:
      platform: event
      event_type: zwave.node_event
      event_data:
        entity_id: zwave.master_toilet_fan
        basic_level: 255
    action:
      service: input_number.set_value
      data:
        entity_id: input_number.master_toilet_fan_timer
        value: 10

  - alias: Cycle master toilet fan during the day
    trigger:
      platform: time_pattern
      hours: "/1"
    condition:
      condition: time
      after: "10:00:00"
      before: "17:00:00"
    action:
      service: input_number.set_value
      data:
        entity_id: input_number.master_toilet_fan_timer
        value: 15

  - alias: Cancel master bedroom salt lamp sleep timer
    trigger:
      - platform: numeric_state
        entity_id: input_number.master_bedroom_salt_lamp_timer
        below: 1
      - platform: state
        entity_id: switch.master_bedroom_salt_lamp
        to: "off"
    action:
      - service: input_number.set_value
        data:
          entity_id: input_number.master_bedroom_salt_lamp_timer
          value: 0
      - service: switch.turn_off
        data:
          entity_id: switch.master_bedroom_salt_lamp
      - service: timer.cancel
        data:
          entity_id: timer.master_bedroom_salt_lamp

  - alias: Set master bedroom salt lamp sleep timer
    trigger:
      platform: state
      entity_id: input_number.master_bedroom_salt_lamp_timer
    action:
      - service: switch.turn_on
        data:
          entity_id: switch.master_bedroom_salt_lamp
      - service: timer.start
        data_template:
          entity_id: timer.master_bedroom_salt_lamp_timer
          duration: >
            {{
              states("input_number.master_bedroom_salt_lamp_timer") | int * 60
            }}

  - alias: "Turn master bedroom salt lamp on at sunset"
    trigger:
      platform: sun
      event: sunset
    action:
      service: switch.turn_on
      data:
        entity_id: switch.master_bedroom_salt_lamp

input_number:
  master_bathroom_fan_timer:
    name: Sleep Timer
    initial: 0
    min: 0
    max: 90
    step: 1
    unit_of_measurement: minutes
    icon: mdi:timer
  master_toilet_fan_timer:
    name: Sleep Timer
    initial: 0
    min: 0
    max: 90
    step: 1
    unit_of_measurement: minutes
    icon: mdi:timer
  master_bedroom_salt_lamp_timer:
    name: Sleep Timer
    initial: 0
    min: 0
    max: 90
    step: 1
    unit_of_measurement: minutes
    icon: mdi:timer

sensor:
  - platform: mqtt
    name: "Climate 2 Temperature"
    state_topic: "tele/climate-sensor-2/SENSOR"
    value_template: "{{ value_json['BME280'].Temperature }}"
    unit_of_measurement: "Â°F"
    device_class: temperature

  - platform: mqtt
    name: "Climate 2 Humidity"
    state_topic: "tele/climate-sensor-2/SENSOR"
    value_template: "{{ value_json['BME280'].Humidity }}"
    unit_of_measurement: "%"
    device_class: humidity

  - platform: mqtt
    name: "Climate 2 Pressure"
    icon: "mdi:cloud"
    state_topic: "tele/climate-sensor-2/SENSOR"
    value_template: "{{ value_json['BME280'].Pressure }}"
    unit_of_measurement: "hPa"

timer:
  master_bathroom_fan_timer:
    name: Sleep Timer Remaining
  master_bedroom_salt_lamp_timer:
    name: Sleep Timer Remaining
  master_toilet_fan_timer:
    name: Sleep Timer Remaining

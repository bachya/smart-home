---
sensor:
  - platform: dnsip
    hostname: !secret base_domain_name

  # Available Versions
  - platform: command_line
    name: AppDaemon Available
    command: >-
      curl -L
      -H "User-Agent: Home Assistant"
      -H "Content-Type: application/json"
      https://pypi.python.org/pypi/appdaemon/json
    value_template: '{{ value_json.info.version }}'
    scan_interval: 1800

  - platform: command_line
    name: ESPHome Available
    command: >-
      curl -L
      -H "User-Agent: Home Assistant"
      -H "Content-Type: application/json"
      https://api.github.com/repos/esphome/esphome/releases/latest
    value_template: '{{ value_json.tag_name[1:] }}'
    scan_interval: 1800

  - platform: command_line
    name: VerneMQ Available
    command: >-
      curl -L
      -H "User-Agent: Home Assistant"
      -H "Content-Type: application/json"
      https://api.github.com/repos/vernemq/vernemq/tags
    value_template: '{{ value_json[0].name }}'
    scan_interval: 1800

  - platform: command_line
    name: Portainer Available
    command: >-
      curl -L
      -H "User-Agent: Home Assistant"
      -H "Content-Type: application/json"
      https://api.github.com/repos/portainer/portainer/releases/latest
    value_template: '{{ value_json.tag_name }}'
    scan_interval: 1800

  - platform: command_line
    name: Yi Hack Available
    command: >-
      curl -L
      -H "User-Agent: Home Assistant"
      -H "Content-Type: application/json"
      https://api.github.com/repos/TheCrypt0/yi-hack-v4/releases/latest
    value_template: '{{ value_json.tag_name[1:] }}'
    scan_interval: 1800

  - platform: version
    name: HASS Available
    source: docker
    beta: true

  # Installed Versions
  - platform: command_line
    name: Yi Hack Installed
    command: >
      ssh -i /config/id_rsa -o StrictHostKeyChecking=no
      root@yi-camera-guest-bedroom.phil.iot cat version

  - platform: version
    name: HASS Installed

    # Networking
  - platform: filter
    name: Filtered Speedtest Download
    entity_id: sensor.speedtest_download
    filters:
      - filter: lowpass
        time_constant: 10
        precision: 2

  - platform: filter
    name: Filtered Speedtest Ping
    entity_id: sensor.speedtest_ping
    filters:
      - filter: lowpass
        time_constant: 10
        precision: 2

  - platform: filter
    name: Filtered Speedtest Upload
    entity_id: sensor.speedtest_upload
    filters:
      - filter: lowpass
        time_constant: 10
        precision: 2

  - platform: pi_hole
    host: gryffindor.phil.lan:8080
    monitored_conditions:
      - ads_blocked_today
      - ads_percentage_today
      - dns_queries_today
      - domains_being_blocked
      - queries_cached
      - queries_forwarded
      - unique_clients
      - unique_domains

  - platform: pi_hole
    host: hufflepuff.phil.lan:8080
    monitored_conditions:
      - ads_blocked_today
      - ads_percentage_today
      - dns_queries_today
      - domains_being_blocked
      - queries_cached
      - queries_forwarded
      - unique_clients
      - unique_domains

  - platform: pi_hole
    host: slytherin.phil.lan:8080
    monitored_conditions:
      - ads_blocked_today
      - ads_percentage_today
      - dns_queries_today
      - domains_being_blocked
      - queries_cached
      - queries_forwarded
      - unique_clients
      - unique_domains

  # CI (Drone.io)
  - platform: command_line
    name: Latest Drone Build
    command: "curl -s 'http://drone/api/repos/bachya/hub/builds?per_page=1' \
            -H 'Authorization: Bearer mKAk7aBngFlvcpWe8ir4FGcSrJ6lgzyd' \
            -H 'User-Agent: Paw/3.1.8 (Macintosh; OS X/10.14.6)' \
            | tr -d []"
    value_template: "{{ value_json.status }}"
    json_attributes:
      - finished
      - message
      - started
      - target
  - platform: template
    sensors:
      latest_drone_build_branch:
        friendly_name: Branch
        value_template: |
          {{ state_attr("sensor.latest_drone_build", "target") }}
      latest_drone_build_duration:
        friendly_name: Duration
        value_template: |
          {% set duration = (
            state_attr("sensor.latest_drone_build", "finished") -
            state_attr("sensor.latest_drone_build", "started")) / 60
          %}
          {% if duration > 0 %}
            {{ duration | round(0) }}
          {% endif %}
        unit_of_measurement: minutes
      latest_drone_build_finished:
        friendly_name: Finished
        entity_id: sensor.latest_drone_build
        value_template: |
          {% set finished = state_attr(
            "sensor.latest_drone_build", "finished"
            )
          %}
          {% if finished > 0 %}
            {{ finished|timestamp_local }}
          {% endif %}
      latest_drone_build_message:
        friendly_name: Message
        value_template: |
          {{ state_attr("sensor.latest_drone_build", "message")[:-1] }}
      latest_drone_build_started:
        friendly_name: Started
        value_template: |
          {{
            state_attr("sensor.latest_drone_build", "started") |
            timestamp_local
          }}
      latest_drone_build_status:
        friendly_name: Status
        value_template: |
          {{ states("sensor.latest_drone_build").title() }}
        icon_template: >
          {% if states("sensor.latest_drone_build") == "failure" %}
            mdi:progress-close
          {% elif states("sensor.latest_drone_build") == "running" %}
            mdi:progress-clock
          {% elif states("sensor.latest_drone_build") == "success" %}
            mdi:progress-check
          {% endif %}

  # Batteries
  - platform: template
    sensors:
      aeotec_nanomote_quad_aaron_bedside_battery:
        entity_id: zwave.aeotec_nanomote_quad_aaron_bedside
        friendly_name: Aeotec Nanomote (AMB Bedside) Battery
        value_template: >
          {{ states.zwave.aeotec_nanomote_quad_aaron_bedside.attributes.battery_level }}
        unit_of_measurement: "%"
        device_class: battery

speedtestdotnet:

switch:
  # Pi-hole
  - platform: command_line
    switches:
      pi_hole_switch:
        friendly_name: Pi-hole
        command_on: !secret pi_hole_on_command
        command_off: !secret pi_hole_off_command
        command_state: "curl -X GET 'http://gryffindor.phil.lan:8080/admin/api.php?status'"
        value_template: "{{ value_json.status == 'enabled' }}"

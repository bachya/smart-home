---
christmas_tree_schedule:
  module: hass_apps_loader
  class: SchedyApp
  constrain_input_boolean: input_boolean.christmas_lights_schedule_automation

  actor_type: switch

  expression_environment: |
    def is_sun_up():
      return state("sun.sun") == "above_horizon"

  rooms:

    living_room:

      actors:
        switch.christmas_tree:

      rescheduling_delay: 0

      schedule:
        - v: "on"
          rules:
            - x: "Skip() if is_sun_up() else Break()"
            - {start: "00:00", end: "09:00", weekdays: 1-5}
            - {start: "00:00", weekdays: 6-7}
        - v: "off"

  watched_entities:
    - sun.sun

fireplace_failsafe_automation:
  module: switches
  class: PresenceFailsafe
  dependencies:
    - guest_mode
    - presence_manager
  entity_ids:
    switch: switch.fireplace
  state_changes:
    - disable:
        event: MODE_CHANGE
        event_data:
          name: guest_mode
          state: "on"
      enable:
        event: MODE_CHANGE
        event_data:
          name: guest_mode
          state: "off"

living_room_lights_on_at_sunset_automation:
  module: switches
  class: ToggleOnState
  dependencies:
    - guest_mode
    - presence_manager
    - vacation_mode
  entity_ids:
    switch: group.living_room_lights
    target: sun.sun
  properties:
    switch_state: "on"
    target_state: "below_horizon"
  constraints:
    constraints:
      constrain_anyone: home,just_arrived
  state_changes:
    - disable:
        event: MODE_CHANGE
        event_data:
          name: guest_mode
          state: "on"
      enable:
        event: MODE_CHANGE
        event_data:
          name: guest_mode
          state: "off"
    - disable:
        event: MODE_CHANGE
        event_data:
          name: vacation_mode
          state: "on"
      enable:
        event: MODE_CHANGE
        event_data:
          name: vacation_mode
          state: "off"

living_room_lights_on_upon_arrival_automation:
  module: switches
  class: ToggleOnState
  dependencies:
    - guest_mode
    - presence_manager
    - vacation_mode
  entity_ids:
    switch: group.living_room_lights
    target: sensor.proximity_zone
  properties:
    switch_state: "on"
    target_state: Home
  constraints:
    constraints:
      constrain_sun: "down"
  state_changes:
    - disable:
        event: MODE_CHANGE
        event_data:
          name: guest_mode
          state: "on"
      enable:
        event: MODE_CHANGE
        event_data:
          name: guest_mode
          state: "off"

living_room_lights_vacation_mode_automation:
  module: switches
  class: VacationMode
  dependencies:
    - guest_mode
    - presence_manager
    - vacation_mode
  entity_ids:
    switch: group.living_room_lights
  properties:
    end_time: "23:30:00"
    start_time: "sunset"
  enabled_toggle_entity_id: input_boolean.vacation_mode_lighting
  state_changes:
    - disable:
        event: MODE_CHANGE
        event_data:
          name: vacation_mode
          state: "off"
      enable:
        event: MODE_CHANGE
        event_data:
          name: vacation_mode
          state: "on"

powder_room_fan_auto_turn_on_automation:
  module: switches
  class: ToggleOnState
  dependencies:
    - presence_manager
  entity_ids:
    switch: switch.powder_room_fan
    target: switch.powder_room_fan
  properties:
    delay: 60
    switch_state: "on"
    target_state: "off"

reading_lamp_cloudy_morning_automation:
  module: switches
  class: ToggleAtTime
  dependencies:
    - guest_mode
    - vacation_mode
  entity_ids:
    switch: switch.reading_lamp
  properties:
    schedule_time: sunrise
    state: "on"
  constraints:
    constraints:
      constrain_dark_outside: true
  state_changes:
    - disable:
        event: MODE_CHANGE
        event_data:
          name: guest_mode
          state: "on"
      enable:
        event: MODE_CHANGE
        event_data:
          name: guest_mode
          state: "off"
    - disable:
        event: MODE_CHANGE
        event_data:
          name: vacation_mode
          state: "on"
      enable:
        event: MODE_CHANGE
        event_data:
          name: vacation_mode
          state: "off"
